name: Deploy to DEV

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd xpos
          docker build -t xpos-app:dev-${{ github.sha }} .
          docker tag xpos-app:dev-${{ github.sha }} xpos-app:dev

      - name: Save Docker image to tar
        run: |
          docker save xpos-app:dev | gzip > xpos-app-dev.tar.gz

      - name: Deploy to server via SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

          # Copy image to server
          sshpass -p 'vonqud-kiqze5-hyWtit' scp -o StrictHostKeyChecking=no \
            xpos-app-dev.tar.gz onyx@20.218.139.129:/tmp/

          # Deploy on server
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 << 'ENDSSH'
            # Load the image
            docker load < /tmp/xpos-app-dev.tar.gz

            # Remove old image file
            rm /tmp/xpos-app-dev.tar.gz

            # Stop and remove old container (if exists)
            docker stop xpos-dev || true
            docker rm xpos-dev || true

            # Run new container on port 8002
            docker run -d \
              --name xpos-dev \
              --restart unless-stopped \
              -p 8002:80 \
              --env-file /home/onyx/xpos/env.dev \
              xpos-app:dev

            # Clean up old images
            docker image prune -f

            echo "DEV deployment completed!"
ENDSSH

      - name: Verify deployment
        run: |
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 'docker ps | grep xpos-dev'

name: Deploy to Development

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches:
      - develop
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  ENVIRONMENT: dev

jobs:
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    environment:
      name: development
      url: https://dev.xpos.az

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl cluster-info

      - name: Create namespace if not exists
        run: |
          kubectl create namespace xpos-dev --dry-run=client -o yaml | kubectl apply -f -

      # Secrets are managed in values-dev.yaml, not in GitHub

      - name: Deploy with Helm
        run: |
          helm upgrade --install xpos ./iac/helm/xpos \
            --namespace xpos-dev \
            --values ./iac/helm/xpos/values-dev.yaml \
            --set image.tag=develop \
            --set image.repository=${{ env.IMAGE_PREFIX }} \
            --set image.registry=${{ env.REGISTRY }} \
            --wait \
            --timeout 10m

      - name: Run Migrations
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=web -n xpos-dev --timeout=300s
          POD=$(kubectl get pod -n xpos-dev -l app.kubernetes.io/component=web -o jsonpath="{.items[0].metadata.name}")
          kubectl exec -it $POD -n xpos-dev -- php artisan migrate --force

      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/xpos-web -n xpos-dev
          kubectl rollout status deployment/xpos-worker -n xpos-dev
          kubectl get pods -n xpos-dev

      - name: Apply Ingress
        run: |
          kubectl apply -f ./iac/ingress-dev.yaml

      # - name: Notify Slack
      #   if: always()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'Deployment to DEV: ${{ job.status }}'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

name: Deploy to Production

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy'
        required: true
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
  ENVIRONMENT: prod

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://app.xpos.az

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version || github.ref }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl cluster-info

      - name: Create namespace if not exists
        run: |
          kubectl create namespace xpos-prod --dry-run=client -o yaml | kubectl apply -f -

      # Secrets are managed in values-prod.yaml, not in GitHub

      - name: Backup current deployment
        run: |
          helm get values xpos -n xpos-prod > /tmp/current-values.yaml || true
          echo "Backup created"

      - name: Deploy with Helm
        run: |
          helm upgrade --install xpos ./iac/helm/xpos \
            --namespace xpos-prod \
            --values ./iac/helm/xpos/values-prod.yaml \
            --set image.tag=${{ steps.version.outputs.version }} \
            --set image.repository=${{ env.IMAGE_PREFIX }} \
            --set image.registry=${{ env.REGISTRY }} \
            --wait \
            --timeout 15m \
            --atomic \
            --cleanup-on-fail

      - name: Run Migrations
        run: |
          kubectl wait --for=condition=ready pod -l app.kubernetes.io/component=web -n xpos-prod --timeout=300s
          POD=$(kubectl get pod -n xpos-prod -l app.kubernetes.io/component=web -o jsonpath="{.items[0].metadata.name}")
          kubectl exec $POD -n xpos-prod -- php artisan migrate --force

      - name: Verify Deployment
        run: |
          kubectl rollout status deployment/xpos-web -n xpos-prod --timeout=10m
          kubectl rollout status deployment/xpos-worker -n xpos-prod --timeout=10m
          kubectl get pods -n xpos-prod

      - name: Apply Ingress
        run: |
          kubectl apply -f ./iac/ingress-prod.yaml

      - name: Run Health Checks
        run: |
          echo "Waiting for application to be healthy..."
          sleep 30
          curl -f https://app.xpos.az/health || exit 1
          echo "Health check passed!"

      - name: Create Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.version.outputs.version }}
          release_name: Release ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false

      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to PRODUCTION ${{ steps.version.outputs.version }}: ${{ job.status }}'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    environment:
      name: production

    steps:
      - name: Setup Kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Configure Kubernetes
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          kubectl cluster-info

      - name: Rollback Helm Release
        run: |
          helm rollback xpos -n xpos-prod
          echo "Rollback completed"

      - name: Verify Rollback
        run: |
          kubectl rollout status deployment/xpos-web -n xpos-prod
          kubectl rollout status deployment/xpos-worker -n xpos-prod

      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          status: 'warning'
          text: 'Production deployment failed and was rolled back'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

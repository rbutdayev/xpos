name: Build and Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd xpos
          docker build -t xpos-app:${{ github.sha }} .
          docker tag xpos-app:${{ github.sha }} xpos-app:latest

      - name: Save Docker image to tar
        run: |
          docker save xpos-app:latest | gzip > xpos-app.tar.gz

      - name: Deploy to server via SSH
        run: |
          # Install sshpass for password-based SSH
          sudo apt-get update
          sudo apt-get install -y sshpass

          # Copy image to server
          sshpass -p 'vonqud-kiqze5-hyWtit' scp -o StrictHostKeyChecking=no \
            xpos-app.tar.gz onyx@20.218.139.129:/tmp/

          # Deploy on server
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 << 'ENDSSH'
          # Load the image
          docker load < /tmp/xpos-app.tar.gz

          # Remove old image file
          rm /tmp/xpos-app.tar.gz

          # Stop and remove old container (if exists)
          docker stop xpos-prod || true
          docker rm xpos-prod || true

          # Run new container
          docker run -d \
            --name xpos-prod \
            --restart unless-stopped \
            -p 8000:80 \
            --env-file /home/onyx/xpos/env.production \
            xpos-app:latest

          # Clean up old images
          docker image prune -f

          echo "Deployment completed!"
          ENDSSH

      - name: Verify deployment
        run: |
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 'docker ps | grep xpos-prod'

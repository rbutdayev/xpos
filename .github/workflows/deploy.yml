name: Deploy to PRODUCTION

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create production .env file
        run: |
          cd xpos
          cat > .env << 'EOF'
          APP_NAME="XPOS - Retail POS"
          APP_ENV=production
          APP_KEY=base64:NlFyjKlET+Ubg4rk4cO0zZZ7ppe/ugk5rEwbl63+AsA=
          APP_DEBUG=false
          APP_URL=https://yourdomain.com

          APP_LOCALE=az
          APP_FALLBACK_LOCALE=en
          APP_FAKER_LOCALE=en_US

          APP_MAINTENANCE_DRIVER=file
          PHP_CLI_SERVER_WORKERS=4
          BCRYPT_ROUNDS=12

          LOG_CHANNEL=stack
          LOG_STACK=single
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=your-azure-mysql.mysql.database.azure.com
          DB_PORT=3306
          DB_DATABASE=xpos
          DB_USERNAME=xpos_user
          DB_PASSWORD=ft59yeCth89oDC

          SESSION_DRIVER=redis
          SESSION_LIFETIME=1440
          SESSION_ENCRYPT=false
          SESSION_PATH=/
          SESSION_DOMAIN=null

          BROADCAST_CONNECTION=log
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=redis

          CACHE_STORE=redis

          REDIS_CLIENT=predis
          REDIS_HOST=redis
          REDIS_PASSWORD=null
          REDIS_PORT=6379

          MAIL_MAILER=smtp
          MAIL_HOST=smtp.gmail.com
          MAIL_PORT=587
          MAIL_USERNAME=your-email@gmail.com
          MAIL_PASSWORD=your-app-password
          MAIL_ENCRYPTION=tls
          MAIL_FROM_ADDRESS="noreply@yourdomain.com"
          MAIL_FROM_NAME="${APP_NAME}"

          AZURE_STORAGE_CONNECTION_STRING=DefaultEndpointsProtocol=https;AccountName=onyxbms;AccountKey=IyNToyDDhyLD/1pUmUQy2sCbKbOqrdBPMVqL07z+3jcRILEfYfzHp/rmKSmm8DDi+EVHnpwVrSpt+AStR2el8A==;EndpointSuffix=core.windows.net
          AZURE_STORAGE_CONTAINER=xpos

          VITE_APP_NAME="${APP_NAME}"
          EOF

      - name: Build Docker image
        run: |
          cd xpos
          docker build -t xpos-app:${{ github.sha }} .
          docker tag xpos-app:${{ github.sha }} xpos-app:latest

      - name: Save Docker image to tar
        run: |
          docker save xpos-app:latest | gzip > xpos-app.tar.gz

      - name: Deploy to server via SSH
        run: |
          # Install sshpass for password-based SSH
          sudo apt-get update
          sudo apt-get install -y sshpass

          # Copy image to server
          sshpass -p 'vonqud-kiqze5-hyWtit' scp -o StrictHostKeyChecking=no \
            xpos-app.tar.gz onyx@20.218.139.129:/tmp/

          # Deploy on server
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 << 'ENDSSH'
          # Load the image
          docker load < /tmp/xpos-app.tar.gz

          # Remove old image file
          rm /tmp/xpos-app.tar.gz

          # Create Docker network if it doesn't exist
          docker network inspect app-network >/dev/null 2>&1 || \
            docker network create app-network

          # Ensure Redis container is running
          if ! docker ps | grep -q redis; then
            echo "Starting Redis container..."
            docker run -d \
              --name redis \
              --network app-network \
              --restart unless-stopped \
              redis:alpine redis-server --appendonly yes
          else
            echo "Redis container already running"
          fi

          # Stop and remove old container (if exists)
          docker stop xpos-prod || true
          docker rm xpos-prod || true

          # Run new container (env is inside the image)
          docker run -d \
            --name xpos-prod \
            --network app-network \
            --restart unless-stopped \
            -p 8000:80 \
            xpos-app:latest

          # Clean up old images
          docker image prune -f

          echo "Deployment completed!"
          ENDSSH

      - name: Verify deployment
        run: |
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 'docker ps | grep xpos-prod'

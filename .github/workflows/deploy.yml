name: Build and Deploy to Server

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    
    :
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          cd xpos
          docker build -t xpos-app:${{ github.sha }} .
          docker tag xpos-app:${{ github.sha }} xpos-app:latest

      - name: Save Docker image to tar
        run: |
          docker save xpos-app:latest | gzip > xpos-app.tar.gz

      - name: Set deployment variables
        id: vars
        run: |
          if [ "${{ github.ref_name }}" == "main" ]; then
            echo "container_name=xpos-prod" >> $GITHUB_OUTPUT
            echo "port=8000" >> $GITHUB_OUTPUT
            echo "env_file=/home/onyx/xpos/env.production" >> $GITHUB_OUTPUT
          else
            echo "container_name=xpos-dev" >> $GITHUB_OUTPUT
            echo "port=8002" >> $GITHUB_OUTPUT
            echo "env_file=/home/onyx/xpos/env.dev" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to server via SSH
        run: |
          # Install sshpass for password-based SSH
          sudo apt-get update
          sudo apt-get install -y sshpass

          # Copy image to server
          sshpass -p 'vonqud-kiqze5-hyWtit' scp -o StrictHostKeyChecking=no \
            xpos-app.tar.gz onyx@20.218.139.129:/tmp/

          # Deploy on server
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 bash << ENDSSH
          # Load the image
          docker load < /tmp/xpos-app.tar.gz

          # Remove old image file
          rm /tmp/xpos-app.tar.gz

          # Stop and remove old container (if exists)
          docker stop ${{ steps.vars.outputs.container_name }} || true
          docker rm ${{ steps.vars.outputs.container_name }} || true

          # Run new container
          docker run -d \
            --name ${{ steps.vars.outputs.container_name }} \
            --restart unless-stopped \
            -p ${{ steps.vars.outputs.port }}:80 \
            --env-file ${{ steps.vars.outputs.env_file }} \
            xpos-app:latest

          # Clean up old images
          docker image prune -f

          echo "Deployment completed!"
          ENDSSH

      - name: Verify deployment
        run: |
          sshpass -p 'vonqud-kiqze5-hyWtit' ssh -o StrictHostKeyChecking=no \
            onyx@20.218.139.129 "docker ps | grep ${{ steps.vars.outputs.container_name }}"

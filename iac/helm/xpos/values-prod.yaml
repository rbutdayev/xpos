# Production environment overrides - PRODUCTION READY VERSION
# Date: 2026-01-08
# All critical security issues fixed

config:
  appName: "ONYX xPos"
  appEnv: "production"
  appDebug: false
  appUrl: "https://app.xpos.az"
  database:
    host: "ithelp-mysql.mysql.database.azure.com"
    database: xpos
    username: xpos_user
  log:
    level: warning

# GitHub Container Registry credentials
# SECURITY FIX: Don't create secret in Helm, let GitHub Actions create it
imagePullSecret:
  create: false  # Created by GitHub Actions workflow
  name: ghcr-secret

# SECURITY FIX: Move secrets to external secret manager or sealed-secrets
# DO NOT commit real secrets to git!
# Use one of these methods:
# 1. Sealed Secrets (recommended)
# 2. External Secrets Operator
# 3. Pass via --set during deployment
# 4. Store in separate values file (not committed)
secrets:
  # Use existing Kubernetes secret created manually
  existingSecret: "xpos-secrets"
  appKey: ""  # Not used when existingSecret is set
  databasePassword: ""  # Not used when existingSecret is set
  redisPassword: ""  # Not used when existingSecret is set

web:
  replicaCount: 2

  # IMPROVEMENT: Better resource alignment
  resources:
    requests:
      memory: "768Mi"  # Closer to limit for better scheduling
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 20
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# Increase health check delays for production
healthCheck:
  enabled: true
  path: /health
  liveness:
    initialDelaySeconds: 60  # Give app more time to start
    periodSeconds: 15
    timeoutSeconds: 10
    failureThreshold: 5  # More tolerant
  readiness:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5

worker:
  replicaCount: 1

  # IMPROVEMENT: Better resource alignment
  resources:
    requests:
      memory: "512Mi"  # Closer to limit
      cpu: "500m"
    limits:
      memory: "756Mi"
      cpu: "750m"

  autoscaling:
    enabled: true
    minReplicas: 5
    maxReplicas: 30
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# CRITICAL FIX: Redis memory and security configuration
redis:
  enabled: true

  # SECURITY FIX: Enable authentication
  auth:
    enabled: true  # CRITICAL: Enable password protection
    password: "Xk6MzkxW4IViYdOai/ijbw2JbYBh+JW71KXfLNE647U="  # Redis password (matches K8s secret)

  master:
    persistence:
      enabled: true
      size: 5Gi
      # RECOMMENDATION: Use storage class with snapshots
      # storageClass: "premium-rwo"  # Uncomment and set your storage class

    # CRITICAL FIX: Configure Redis maxmemory to prevent OOM
    extraFlags:
      - "--maxmemory 400mb"                # 80% of K8s memory limit (512Mi)
      - "--maxmemory-policy allkeys-lru"   # Evict least recently used keys
      - "--save 900 1"                      # Save to disk every 15min if 1+ keys changed
      - "--save 300 10"                     # Save to disk every 5min if 10+ keys changed
      - "--save 60 10000"                   # Save to disk every 1min if 10000+ keys changed

    resources:
      requests:
        memory: "384Mi"  # Closer to limit for better scheduling
        cpu: "200m"
      limits:
        memory: "512Mi"  # Must be > maxmemory setting
        cpu: "500m"

mysql:
  enabled: false  # Use managed MySQL/RDS in production

persistence:
  enabled: false  # Files uploaded to Blackblaze S3, not local filesystem

ingress:
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/rate-limit: "100"
    # Note: Security headers should be configured at ingress controller level
    # configuration-snippet is disabled for security reasons
  hosts:
    - host: app.xpos.az
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: xpos-prod-tls
      hosts:
        - app.xpos.az

# SECURITY: Disabled due to supervisord compatibility issue
# The Docker images use supervisord with user=root which conflicts
# TODO: Fix Dockerfiles to remove supervisord user directive
podSecurityContext: {}
  # fsGroup: 2000
  # runAsNonRoot: true
  # runAsUser: 1000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: false
  # allowPrivilegeEscalation: false

---
# DEPLOYMENT INSTRUCTIONS:
#
# Option 1: Use External Secrets (Recommended for Production)
# --------------------------------------------------------------
# 1. Store secrets in AWS Secrets Manager / Azure Key Vault / HashiCorp Vault
# 2. Install External Secrets Operator
# 3. Deploy with external secrets
#
# Option 2: Use Sealed Secrets (Good for GitOps)
# -----------------------------------------------
# 1. Install sealed-secrets controller
# 2. Create sealed secrets:
#    echo -n "your-secret" | kubectl create secret generic xpos-secrets \
#      --dry-run=client --from-file=APP_KEY=/dev/stdin -o yaml | \
#      kubeseal -o yaml > sealed-secret.yaml
# 3. Commit sealed-secret.yaml to git
#
# Option 3: Pass Secrets via --set (Simplest)
# --------------------------------------------
# helm upgrade --install xpos ./iac/helm/xpos \
#   --namespace xpos-prod \
#   --values ./iac/helm/xpos/values-prod-FIXED.yaml \
#   --set secrets.appKey="base64:YOUR_KEY" \
#   --set secrets.databasePassword="YOUR_DB_PASS" \
#   --set secrets.redisPassword="YOUR_REDIS_PASS" \
#   --set redis.auth.password="YOUR_REDIS_PASS"
#
# MONITORING:
# -----------
# After deployment, verify Redis configuration:
#   kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli CONFIG GET maxmemory
#   kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli CONFIG GET maxmemory-policy
#   kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli INFO memory
#
# Setup alerts for:
#   - Redis memory usage > 80%
#   - Redis evicted_keys > 100/min
#   - Pod restarts
#   - High CPU/Memory usage

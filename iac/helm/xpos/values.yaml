# Default values for xpos - PRODUCTION READY VERSION
# This is a YAML-formatted file.
# Date: 2026-01-08
# All critical security issues fixed

# Global settings
global:
  imagePullSecrets:
    - name: ghcr-secret
  storageClass: ""

# SECURITY FIX: GitHub Container Registry Secret
# DO NOT hardcode credentials here!
# Let CI/CD create the secret or create manually in Kubernetes
imagePullSecret:
  create: false  # CHANGED: Don't create in Helm, create externally
  name: ghcr-secret
  # To create manually:
  # kubectl create secret docker-registry ghcr-secret \
  #   --docker-server=ghcr.io \
  #   --docker-username=<your-username> \
  #   --docker-password=<your-token> \
  #   --namespace=<namespace>

# Image settings
image:
  registry: ghcr.io
  repository: rbutdayev/xpos
  pullPolicy: Always  # Changed from IfNotPresent to ensure latest images are pulled
  tag: ""  # Overrides the image tag (default is chart appVersion)

# Web application
web:
  replicaCount: 2

  image:
    name: web

  # IMPROVEMENT: Better resource alignment
  resources:
    requests:
      memory: "768Mi"  # Closer to limit for predictable scheduling
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  service:
    type: ClusterIP
    port: 80

  autoscaling:
    enabled: false
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

# Queue workers
worker:
  replicaCount: 2

  image:
    name: worker

  # IMPROVEMENT: Better resource alignment
  resources:
    requests:
      memory: "384Mi"  # Closer to limit
      cpu: "200m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80

  # Queue worker command args
  args:
    connection: redis
    sleep: 3
    tries: 3
    maxTime: 3600

# Scheduler (cron)
scheduler:
  enabled: true

  image:
    name: scheduler

  resources:
    requests:
      memory: "128Mi"
      cpu: "50m"
    limits:
      memory: "256Mi"
      cpu: "200m"

# CRITICAL FIX: Redis Configuration
redis:
  enabled: true
  architecture: standalone

  # SECURITY FIX: Enable auth by default
  auth:
    enabled: true  # CHANGED: Enable password protection
    password: ""   # Set in environment-specific values files

  master:
    persistence:
      enabled: true
      size: 5Gi

    # CRITICAL FIX: Configure Redis maxmemory to prevent OOM
    extraFlags:
      - "--maxmemory 400mb"                # 80% of K8s memory limit (512Mi)
      - "--maxmemory-policy allkeys-lru"   # Evict least recently used keys
      - "--save 900 1"                      # Persistence: save every 15min if 1+ keys changed
      - "--save 300 10"                     # Persistence: save every 5min if 10+ keys changed
      - "--save 60 10000"                   # Persistence: save every 1min if 10000+ keys changed
      - "--tcp-backlog 511"                 # Connection queue size
      - "--timeout 300"                     # Close idle connections after 5min
      - "--tcp-keepalive 60"                # TCP keepalive

    # IMPROVEMENT: Better resource alignment
    resources:
      requests:
        memory: "384Mi"  # Closer to limit
        cpu: "200m"
      limits:
        memory: "512Mi"  # Must be > maxmemory (400mb)
        cpu: "500m"

# MySQL (if you want to deploy MySQL in k8s)
mysql:
  enabled: false  # Set to true if deploying MySQL in cluster
  auth:
    rootPassword: ""
    database: xpos
    username: xpos
    password: ""
  primary:
    persistence:
      enabled: true
      size: 20Gi

# Application configuration
config:
  appName: "XPOS"
  appEnv: "production"
  appDebug: false
  appUrl: "https://xpos.yourdomain.com"

  # Database
  database:
    connection: mysql
    host: "mysql-host"  # External MySQL or service name
    port: 3306
    database: xpos
    username: xpos
    # Password should be in secrets

  # Redis config
  cache:
    driver: redis
  queue:
    connection: redis
  session:
    driver: redis

  # Logging
  log:
    channel: stderr
    level: info

# Secrets (reference existing secrets or create new ones)
# SECURITY: DO NOT commit real secrets to git!
secrets:
  # If existingSecret is set, it will use that instead of creating new one
  existingSecret: ""

  # These are used only if existingSecret is not set
  # Pass via --set or use external secret manager
  appKey: ""  # Laravel APP_KEY (generate with: php artisan key:generate --show)
  databasePassword: ""
  redisPassword: ""

# Ingress
ingress:
  enabled: true
  className: "nginx"
  annotations:
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers-number: "4"
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "256k"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";

  hosts:
    - host: xpos.yourdomain.com
      paths:
        - path: /
          pathType: Prefix

  tls:
    - secretName: xpos-tls
      hosts:
        - xpos.yourdomain.com

# Persistent storage
persistence:
  enabled: true
  storageClass: ""
  accessMode: ReadWriteMany  # Requires NFS or similar
  size: 20Gi
  annotations: {}

# Health checks
healthCheck:
  enabled: true
  path: /health
  liveness:
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readiness:
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod annotations
podAnnotations: {}

# SECURITY: Pod security context
podSecurityContext:
  fsGroup: 2000
  runAsNonRoot: true
  runAsUser: 1000

# SECURITY: Container security context
securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: false  # Laravel needs write access to storage
  allowPrivilegeEscalation: false

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

---
# USAGE INSTRUCTIONS:
#
# 1. Create imagePullSecret manually or via CI/CD:
#    kubectl create secret docker-registry ghcr-secret \
#      --docker-server=ghcr.io \
#      --docker-username=<username> \
#      --docker-password=<token> \
#      --namespace=<namespace>
#
# 2. Deploy with secrets:
#    helm upgrade --install xpos ./iac/helm/xpos \
#      --namespace xpos-prod \
#      --values ./iac/helm/xpos/values-FIXED.yaml \
#      --set secrets.appKey="base64:xxx" \
#      --set secrets.databasePassword="xxx" \
#      --set secrets.redisPassword="xxx" \
#      --set redis.auth.password="xxx"
#
# 3. Verify Redis configuration:
#    kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli CONFIG GET maxmemory
#    kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli CONFIG GET maxmemory-policy
#
# 4. Monitor Redis memory:
#    kubectl exec -it xpos-redis-master-0 -n xpos-prod -- redis-cli INFO memory
#
# SECURITY CHECKLIST:
# - [ ] imagePullSecret created externally (not in values file)
# - [ ] Redis auth enabled
# - [ ] Redis maxmemory configured
# - [ ] Secrets passed via --set or external secret manager
# - [ ] Production secrets not committed to git
# - [ ] Security context configured
# - [ ] Resource requests close to limits

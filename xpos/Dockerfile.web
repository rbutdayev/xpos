# Multi-stage Dockerfile for Laravel xpos - Web Application
# This runs PHP-FPM + Nginx for handling HTTP requests

### Stage 1: Build frontend assets using Node
FROM node:20-alpine AS node-builder
WORKDIR /var/www

COPY package.json package-lock.json* ./
RUN npm ci --silent || npm install --silent
COPY . .
RUN npm run build

### Stage 2: Prepare PHP environment & Composer install
FROM php:8.3-fpm-alpine AS php-builder
WORKDIR /var/www

# System dependencies
RUN apk add --no-cache --virtual .build-deps \
    $PHPIZE_DEPS \
    autoconf \
    libzip-dev \
    icu-dev \
    oniguruma-dev \
    zlib-dev \
    libpng-dev \
    libjpeg-turbo-dev \
    freetype-dev \
    gcc \
    g++ \
    make \
    curl \
    git \
    bash \
  && apk add --no-cache ca-certificates

# PHP extensions
RUN docker-php-ext-configure gd --with-freetype --with-jpeg \
  && docker-php-ext-install -j$(nproc) pdo pdo_mysql zip gd bcmath intl mbstring pcntl opcache

# Redis extension
RUN pecl install redis && docker-php-ext-enable redis

# Composer
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

# Install dependencies
COPY composer.json composer.lock* ./
RUN composer install --no-dev --prefer-dist --no-interaction --optimize-autoloader --no-scripts || composer install --no-interaction

COPY . .

### Stage 3: Final web image
FROM php:8.3-fpm-alpine
WORKDIR /var/www

# Runtime deps + Nginx + Supervisor (still needed for php-fpm + nginx in same container)
RUN apk add --no-cache bash ca-certificates openssl curl libzip zlib libpng libjpeg-turbo freetype \
    icu-libs icu-data-full oniguruma \
    nginx supervisor

# Copy PHP extensions
COPY --from=php-builder /usr/local/lib/php/extensions/ /usr/local/lib/php/extensions/
COPY --from=php-builder /usr/local/etc/php/conf.d/ /usr/local/etc/php/conf.d/

# Copy app files
COPY --from=php-builder /var/www /var/www

# Copy built frontend assets
COPY --from=node-builder /var/www/public/build /var/www/public/build

# Copy Nginx configuration
COPY nginx.conf /etc/nginx/http.d/default.conf

# Supervisor config for PHP-FPM + Nginx (NOT queue workers)
RUN mkdir -p /etc/supervisor.d && \
    echo '[supervisord]' > /etc/supervisor.d/supervisord.ini && \
    echo 'nodaemon=true' >> /etc/supervisor.d/supervisord.ini && \
    echo 'user=root' >> /etc/supervisor.d/supervisord.ini && \
    echo 'logfile=/dev/stdout' >> /etc/supervisor.d/supervisord.ini && \
    echo 'logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo '' >> /etc/supervisor.d/supervisord.ini && \
    echo '[program:php-fpm]' >> /etc/supervisor.d/supervisord.ini && \
    echo 'command=php-fpm -F' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autorestart=true' >> /etc/supervisor.d/supervisord.ini && \
    echo '' >> /etc/supervisor.d/supervisord.ini && \
    echo '[program:nginx]' >> /etc/supervisor.d/supervisord.ini && \
    echo 'command=nginx -g "daemon off;"' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile=/dev/stdout' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stdout_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile=/dev/stderr' >> /etc/supervisor.d/supervisord.ini && \
    echo 'stderr_logfile_maxbytes=0' >> /etc/supervisor.d/supervisord.ini && \
    echo 'autorestart=true' >> /etc/supervisor.d/supervisord.ini

# Set permissions
RUN chown -R www-data:www-data /var/www/storage /var/www/bootstrap/cache || true && \
    mkdir -p /run/nginx && \
    mkdir -p /var/lib/nginx/tmp/client_body \
             /var/lib/nginx/tmp/proxy \
             /var/lib/nginx/tmp/fastcgi \
             /var/lib/nginx/tmp/uwsgi \
             /var/lib/nginx/tmp/scgi && \
    chown -R nginx:nginx /var/lib/nginx /var/log/nginx && \
    chmod -R 755 /var/lib/nginx && \
    mkdir -p /var/www/storage/logs /var/www/storage/app/public && \
    chmod -R 775 /var/www/storage

EXPOSE 80

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisor.d/supervisord.ini"]
